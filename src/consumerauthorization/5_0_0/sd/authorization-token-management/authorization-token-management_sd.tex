\documentclass[a4paper]{arrowhead}

\usepackage[yyyymmdd]{datetime}
\usepackage{etoolbox}
\usepackage[utf8]{inputenc}
\usepackage{multirow}

\renewcommand{\dateseparator}{-}

\setlength{\parskip}{1em}
\hyphenation{Er-ror-Res-pon-se}
\hyphenation{Au-thor-i-za-ti-on-Po-li-cy-List-Res-pon-se}

%% Special references
\newcommand{\fref}[1]{{\textcolor{ArrowheadBlue}{\hyperref[sec:functions:#1]{#1}}}}
\newcommand{\mref}[1]{{\textcolor{ArrowheadPurple}{\hyperref[sec:model:#1]{#1}}}}
\newcommand{\prref}[1]{{\textcolor{ArrowheadPurple}{\hyperref[sec:model:primitives:#1]{#1}}}}
\newcommand{\pdef}[1]{{\textcolor{ArrowheadGrey}{#1\label{sec:model:primitives:#1}\label{sec:model:primitives:#1s}\label{sec:model:primitives:#1es}}}}
\newcommand{\pref}[1]{{\textcolor{ArrowheadGrey}{\hyperref[sec:model:primitives:#1]{#1}}}}

\newrobustcmd\fsubsection[5]{
  \addtocounter{subsection}{1}
  \addcontentsline{toc}{subsection}{\protect\numberline{\thesubsection}operation \textcolor{ArrowheadBlue}{#1}}
  \renewcommand*{\do}[1]{\rref{##1},\ }
  \subsection*{
    \thesubsection\quad
    operation
    \textcolor{ArrowheadBlue}{#1}
    (\notblank{#2}{\mref{#2}}{})
    \notblank{#3}{: \mref{#3}}{}
    \notblank{#4}{: \prref{#4}}{}
    \notblank{#5}{/ \mref{#5}}{}
  }
  \label{sec:functions:#1}
}
\newrobustcmd\msubsection[2]{
  \addtocounter{subsection}{1}
  \addcontentsline{toc}{subsection}{\protect\numberline{\thesubsection}#1 \textcolor{ArrowheadPurple}{#2}}
  \subsection*{\thesubsection\quad#1 \textcolor{ArrowheadPurple}{#2}}
  \label{sec:model:#2} \label{sec:model:#2s} \label{sec:model:#2es}
}
\newrobustcmd\msubsubsection[3]{
  \addtocounter{subsubsection}{1}
  \addcontentsline{toc}{subsubsection}{\protect\numberline{\thesubsubsection}#1 \textcolor{ArrowheadPurple}{#2}}
  \subsubsection*{\thesubsubsection\quad#1 \textcolor{ArrowheadPurple}{#2}}
  \label{sec:model:#2} \label{sec:model:#2s}
}
%%

\begin{document}

%% Arrowhead Document Properties
\ArrowheadTitle{authorizationTokenManagement} % XXX = ServiceName 
\ArrowheadServiceID{authorizationTokenManagement} % ID name of service
\ArrowheadType{Service Description}
\ArrowheadTypeShort{SD}
\ArrowheadVersion{5.0.0} % Arrowhead version X.Y.Z, e..g. 4.4.1
\ArrowheadDate{\today}
\ArrowheadAuthor{Tam√°s Bordi} % Corresponding author e.g. Jerker Delsing
\ArrowheadStatus{DRAFT} % e..g. RELEASE, RELEASE CONDIDATE, PROTOTYPE
\ArrowheadContact{tbordi@aitia.ai} % Email of corresponding author
\ArrowheadFooter{\href{www.arrowhead.eu}{www.arrowhead.eu}}
\ArrowheadSetup
%%

%% Front Page
\begin{center}
  \vspace*{1cm}
  \huge{\arrowtitle}

  \vspace*{0.2cm}
  \LARGE{\arrowtype}
  \vspace*{1cm}

  %\Large{Service ID: \textit{"\arrowid"}}
  \vspace*{\fill}

  % Front Page Image
  %\includegraphics{figures/TODO}

  \vspace*{1cm}
  \vspace*{\fill}

  % Front Page Abstract
  \begin{abstract}
    This document provides service description for the \textbf{authorizationToken} service. 
  \end{abstract}

  \vspace*{1cm}

%   \scriptsize
%   \begin{tabularx}{\textwidth}{l X}
%     \raisebox{-0.5\height}{\includegraphics[width=2cm]{figures/artemis_logo}} & {ARTEMIS Innovation Pilot Project: Arrowhead\newline
%     THEME [SP1-JTI-ARTEMIS-2012-AIPP4 SP1-JTI-ARTEMIS-2012-AIPP6]\newline
%     [Production and Energy System Automation Intelligent-Built environment and urban infrastructure for sustainable and friendly cities]}
%   \end{tabularx}
%   \vspace*{-0.2cm}
 \end{center}

\newpage
%%

%% Table of Contents
\tableofcontents
\newpage
%%

\section{Overview}
\label{sec:overview}
This document describes the \textbf{authorizationTokenManagement} service, which allows systems (with operator role or proper permission) to manage the service access tokens in bulk and on behalf of the consumer and provider systems. Access tokens enable the verification of service consumption permissions on the provider system side, and the application of session-based service consumption control between the consumer and provider systems. An example of this interaction when a Core/Support system generates tokens for a consumer system for multiple service instances.

The \textbf{authorizationTokenManagement} service contains the following operations:

\begin{itemize}
    \item \textit{generate-tokens} verifies the given consumer systems' permissions and produces the tokens of defined types for the targeted service instances;
    \item \textit{query-tokens} lists the access tokens that match the filtering requirements;
    \item \textit{revoke-tokens} remove access token records by token references;
    \item \textit{add-encryption-keys} stores the defined encryption keys that can be used to encrypt the raw tokens generated for any service of the associated provider systems.
    \item \textit{remove-encryption-keys} removes the encryption keys associated with the given provider system names.
\end{itemize}

The rest of this document is organized as follows.
In Section \ref{sec:functions}, we describe the abstract message operations provided by the service.
In Section \ref{sec:model}, we end the document by presenting the data types used by the mentioned operations.

\subsection{How This Service Is Meant to Be Used}

The purpose of this service is to handle the access tokens centrally and in bulk. This approach makes it possible for consumer systems to avoid generating tokens for multiple service instances individually. Also, provider systems don't have to register/unregister their token encryption keys on their own, it can be outsourced.

Several token variants could be available, that are gouped into the following types:

\textbf{Simple token}s are not holding any kind of information. These can only be verified by consulting the system implementing the authorizationToken service.

\textbf{Self-contained token}s are holding all the necessary information for the provider system to verify it independently. However, the way of accessing to the token payload could differ according to the exact self-contained token variant. Since these kinds of tokens are holding sensitive information, there is an option to encrypt the tokens using an encryption key associated with the provider.

\subsection{Important Delimitations}
\label{sec:delimitations}

The requester has to identify itself to use any of the operations.

\subsection{Access policy}
\label{sec:accesspolicy}

The service is only available for operators, dedicated Core/Support systems and those who have the proper
authorization rights to consume it.

\newpage

\section{Service Operations}
\label{sec:functions}

This section describes the abstract signatures of each operations of the service. In particular, each subsection names an operation, an input type and one or two output types (unsuccessful operations can return different structure), in that order.
The input type is named inside parentheses, while the output type is preceded by a colon. If the operation has two output types, they are separated by a slash.
Input and output types are only denoted when accepted or returned, respectively, by the operation in question. All abstract data types named in this section are defined in Section 3.

\phantomsection
\fsubsection{generate-tokens}{AuthorizationTokenGenerationListMgmtRequest}{AuthorizationTokenMgmtListResponse}{}{ErrorResponse}

Operation \textit{generate-tokens} verifies the given consumer systems' permissions to the targeted service/service-operation instance and produces expiring tokens of defined types associated with the consumer system, service provider system and  service instance triplets. The operation returns the generated tokens and the belonged details.

\fsubsection{query-tokens}{AuthorizationTokenQueryRequest}{AuthorizationTokenMgmtListResponse}{}{ErrorResponse}

Operation \textit{query-tokens} lists the access tokens that match the filtering requirements. The query data must meet the following criteria:

\begin{itemize}
    \item The operation returns results in pages. There are default page data settings, but the requester can provide a custom specification.
    \item If page number is specified, the page size must be specified as well and vice versa.
    \item In some Local Clouds there is a maximum page size.
    \item If a filter expects a list, there is an OR relation between the elements of the filter.
    \item There is an AND relation between different kind of filters
\end{itemize}

\fsubsection{revoke-tokens}{AuthorizationTokenRemoveRequest}{OperationStatus}{}{ErrorResponse}

Operation \textit{revoke-tokens} deletes the access token records associated with the given token references. In case of simple tokens this operation can close a session between a consumer and provider.

\fsubsection{add-encryption-keys}{AuthorizationEncryptionKeyMgmtListRequest}{AuthorizationEncryptionKeyMgmtListResponse}{}{ErrorResponse}

Operation \textit{add-encryption-keys} saves and stores \pref{String} key and encryption algorithm identifier pairs belonging to the given provider systems. If the given algorithm is using any addition (besides the encryption key) for the encryption process, such as salt or initialization vector for example, then this addition is returned to the requester system. Any time when a self-contained token is generated that is associated with a provider that has an encryption key saved, the token will be provided to the token requester encrypted, using the specified key and encryption algorithm.

\fsubsection{remove-encryption-keys}{AuthorizationEncryptionKeyRemoveMgmtRequest}{OperationStatus}{}{ErrorResponse}

Operation \textit{remove-encryption-keys} deletes the stored encryption key and algorithm identifier pairs associated with the given provider systems. The result of this operation is that further tokens generated to any service of the affected provider systems, won't be encrypted. 

\clearpage

\section{Information Model}
\label{sec:model}

Here, all data objects that can be part of the \textbf{authorizationTokenManagement} service are listed and must be respected by the hosting system.
Note that each subsection, which describes one type of object, begins with the \textit{struct} keyword, which is used to denote a collection of named fields, each with its own data type.
As a complement to the explicitly defined types in this section, there is also a list of implicit primitive types in Section \ref{sec:model:primitives}, which are used to represent things like hashes and identifiers.

\phantomsection

\msubsection{struct}{AuthorizationTokenGenerationListMgmtRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{3cm} | p{8cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
authentication & \hyperref[sec:model:Identity]{Identity} & yes & The requester of the operation. \\ \hline
list & \pref{List}$<$\hyperref[sec:model:AuthorizationTokenGenerationMgtmRequest]{AuthorizationTokenGenerationMgtmRequest}$>$ & yes & List of token requests. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{Identity}

An \pref{Object} which describes the identity of a system. It also contains whether the identified system has higher level administrative rights.

\msubsection{struct}{AuthorizationTokenGenerationMgtmRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{3cm} | p{4.5cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
tokenVariant & \pref{AccessTokenVariant} & yes & Exact type of token technology. \\ \hline
targetType & \pref{AccessTargetType} & yes & Type of the targeted resource. \\ \hline
consumerCloud & \pref{CloudIdentifier} & no & Cloud of the consumer. \\ \hline
consumer & \pref{SystemName} & yes & Name of consumer. \\ \hline
provider & \pref{SystemName} & yes & Name of the targeted provider system. \\ \hline
target & \pref{ServiceName} / \pref{EventTypeName} & yes & Target of the token. \\ \hline
scope & \hyperref[sec:model:AccessTokenScope]{AccessTokenScope} & no & Scope of the token. Only matters when the target is a service definition. \\ \hline
expiresAt & \pref{DateTime} & no & Token will be valid until this timestamp. Only in case of time limited tokens. Default time limit is applied if not defined. \\ \hline
usageLimit & \pref{Number} & no & How many times the token will be valid. Only in case of usage limited tokens. Default usage limit is applied if not defined. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AccessTokenScope}

A \pref{String} which specifies the scope of the token. It can be \pref{ServiceOperationName} if the token target is a \pref{ServiceName} and the token is limited to one particular service-operation or it can be empty if the token is not limited or the target is an \pref{EventTypeName}. 

\msubsection{struct}{AuthorizationTokenQueryRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{3cm} | p{3cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
authentication &\hyperref[sec:model:Identity]{Identity} & yes & The requester of the operation. \\ \hline
pageNumber & \pref{Number} & no (yes) & The number of the requested page. It is mandatory, if page size is specified. \\ \hline
pageSize & \pref{Number} & no (yes) & The number of entries on the requested page. It is mandatory, if page number is specified. \\ \hline
pageSortField & \pref{String} & no & The identifier of the field which must be used to sort the entries. \\ \hline
pageDirection & \pref{Direction} & no & The direction of the sorting. \\ \hline
requester & \pref{SystemName} & no & Requester is looking for tokens that were generated by the request of the specified system. \\ \hline
tokenType & \pref{AccessTokenType} & no &  Requester is looking for tokens that belong to the specified technology group. \\ \hline
consumerCloud & \pref{CloudIndetifier} & no &  Requester is looking for tokens that belong to the specified consumer cloud. \\ \hline
consumer & \pref{SystemName} & no &  Requester is looking for tokens that belong to the specified consumer system. \\ \hline
provider & \pref{SystemName} & no &  Requester is looking for tokens that belong to the specified provider system. \\ \hline
targetType & \pref{AccessTargetType} & no &  Requester is looking for tokens that belong to the specified target type. \\ \hline
target & \pref{ServiceName} / \pref{EventTypeName} & no &  Requester is looking for tokens that belong to the specified service-operation. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AuthorizationTokenRemoveRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{2.5cm} | p{4.8cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
authentication & \hyperref[sec:model:Identity]{Identity} & yes & The requester of the operation. \\ \hline
list & \pref{List}$<$\pref{AccessTokenReference}$>$ & yes & List of token references. \\ \hline
\end{tabularx}
\end{table}

\clearpage

\msubsection{struct}{AuthorizationEncryptionKeyMgmtListRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{2.5cm} | p{7.5cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
authentication & \hyperref[sec:model:Identity]{Identity} & yes & The requester of the operation. \\ \hline
list & \pref{List}$<$\hyperref[sec:model:AuthorizationEncryptionKeyMgmtRequest]{AuthorizationEncryptionKeyMgmtRequest}$>$ & yes & List of encryption key request. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AuthorizationEncryptionKeyMgmtRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{3cm} | p{4.5cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
systemName & \pref{SystemName} & yes & Name of the associated system. \\ \hline
key & \pref{String} & yes & A secret key. \\ \hline
algorithm & \pref{EncryptionAlgorithmName} & yes & A specific algorithm. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AuthorizationEncryptionKeyRemoveMgmtRequest}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{2.5cm} | p{4cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Mandatory & Description \\ \hline
authentication & \hyperref[sec:model:Identity]{Identity} & yes & The requester of the operation. \\ \hline
list & \pref{List}$<$\pref{SystemName}$>$ & yes & System name list of associated keys to be deleted. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AuthorizationTokenMgmtListResponse}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{1.5cm} | p{8.2cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Description \\ \hline
entries & \pref{List}$<$\hyperref[sec:model:AuthorizationTokenMgmtResponse]{AuthorizationTokenMgmtResponse}$>$ & List of token results. \\ \hline
count & \pref{Number} & Number of returned results. \\ \hline
\end{tabularx}
\end{table}

\clearpage

\msubsection{struct}{AuthorizationTokenMgmtResponse}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{4.25cm} | p{4.5cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Description \\ \hline
status & \pref{OperationStatus} & Status of the operation. \\ \hline
tokenType & \pref{AccessTokenType} & Type of token technology group. \\ \hline
variant & \pref{AccesTokenVariant} & Exact type of token technology. \\ \hline
token & \pref{AccessToken} & The token itself. \\ \hline
tokenReference & \pref{String} & Reference of the token record. \\ \hline
requester & \pref{SystemName} & Name of the system that requested the token. \\ \hline
consumerCloud & \pref{CloudIdentifier} & Cloud of the consumer. \\ \hline
consumer & \pref{SystemName} & Name of the consumer system. \\ \hline
provider & \pref{SystemName} & Name of the provider system. \\ \hline
targetType & \pref{AccessTargetType} & Type of the targeted resource. \\ \hline
target & \pref{ServiceName} / \pref{EventTypeName} & Target of the token. \\ \hline
scope & \hyperref[sec:model:AccessTokenScope]{AccessTokenScope} & Scope of the token. \\ \hline
createdAt & \pref{DateTime} & Token was generated at this timestamp. \\ \hline
usageLimit & \pref{Number} & Maximum number of token usage, if any. \\ \hline
usageLeft & \pref{Numer} & The token can still be used this many times, if any. \\ \hline
expiresAt & \pref{DateTime} & Token is valid until this timestamp, if any. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{ErrorResponse}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{4.25cm} | p{3.5cm} | X |} \hline
\rowcolor{gray!33} Field & Type      & Description \\ \hline
status & \pref{OperationStatus} & Status of the operation. \\ \hline
errorMessage & \pref{String} & Description of the error. \\ \hline
errorCode &\pref{Number}  & Numerical code of the error. \\ \hline
type & \pref{ErrorType} & Type of the error. \\ \hline
origin & \pref{String} & Origin of the error. \\ \hline
\end{tabularx}
\end{table}

\msubsection{struct}{AuthorizationEncryptionKeyMgmtListResponse}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{2cm} | p{7.8cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Description \\ \hline
status & \pref{OperationStatus} & Status of the operation. \\ \hline
entries & \pref{List}$<$\hyperref[sec:model:AuthorizationEncryptionKeyMgmtResponse]{AuthorizationEncryptionKeyMgmtResponse}$>$ & Result entries. \\ \hline
count & \pref{Number} & Numer of the result entries. \\ \hline
\end{tabularx}
\end{table}

\clearpage

\msubsection{struct}{AuthorizationEncryptionKeyMgmtResponse}

\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{4.25cm} | p{4.5cm} | X |} \hline
\rowcolor{gray!33} Field & Type & Description \\ \hline
systemName & \pref{SystemName} & Name of the associated system. \\ \hline
rawKey & \pref{String} & The raw string key. \\ \hline
algorithm & \pref{EncryptionAlgorithmName} & Name of the ecnryption algorithm. \\ \hline
keyAdditive & \pref{String} & Any string addition that the defined algorithm is using, if any. \\ \hline
createdAt & \pref{DateTime} & The encryprtion key was registered at this timestamp. \\ \hline
\end{tabularx}
\end{table}

\newpage

\subsection{Primitives}
\label{sec:model:primitives}

Types and structures mentioned throughout this document that are assumed to be available to implementations of this service.
The concrete interpretations of each of these types and structures must be provided by any IDD document claiming to implement this service.


\begin{table}[ht!]
\begin{tabularx}{\textwidth}{| p{5cm} | X |} \hline
\rowcolor{gray!33} Type & Description \\ \hline
\pdef{AccessTargetType} & A string reference that specifies the type of the targeted resource. \\ \hline
\pdef{AccessToken} & A random and possibly unique string of characters that is issued for a beneficiary system and is associated at least with a target system, a scope and is expiring.\\ \hline
\pdef{AccessTokenReference} & A string reference that is associated with the access token record. \\ \hline
\pdef{AccessTokenType} & A string reference that specifies a token technology group.\\ \hline
\pdef{AccessTokenVariant} & A string reference that specifies an exact token technology variant.\\ \hline
\pdef{CloudIdentifier} & A composite string identifier that is intended to be both human and machine-readable. It consists of the cloud name and the organization name that is managing the cloud. Each part must follow the PascalCase naming convention. \\ \hline
\pdef{DateTime}         & Pinpoints a specific moment in time. \\ \hline
\pdef{Direction}        & The direction of a sorting operation. Possible values are the representation of ascending or descending order. \\ \hline
\pdef{ErrorType}        & Any suitable type chosen by the implementor of service. \\ \hline
\pdef{EncryptionAlgorithmName} & A string identifier that belongs to an encryption algorithm. \\ \hline
\pdef{EventTypeName}      & A string identifier that is intended to be both human and machine-readable. Must follow camelCase naming convention. \\ \hline
\pdef{List}$<$A$>$      & An \textit{array} of a known number of items, each having type A. \\ \hline
\pdef{Object}           & Set of primitives and possible further objects. \\ \hline
\pdef{OperationStatus}  & Logical, textual or numerical value that indicates whether an operation is a success or a failure. Multiple values can be used for success and error cases to give additional information about the nature of the result. \\ \hline
\pdef{ServiceName}      & A string identifier that is intended to be both human and machine-readable. Must follow camelCase naming convention. \\ \hline
\pdef{ServiceOperationName} & A string identifier that is intended to be both human and machine-readable. Must follow kebab-case naming convention. \\ \hline
\pdef{String}           & A chain of characters. \\ \hline
\pdef{SystemName}       & A string identifier that is intended to be both human and machine-readable. Must follow PascalCase naming convention. \\ \hline
\end{tabularx}
\end{table}

\newpage

\bibliographystyle{IEEEtran}
\bibliography{bibliography}

\newpage

\section{Revision History}
\subsection{Amendments}

\noindent\begin{tabularx}{\textwidth}{| p{1cm} | p{3cm} | p{2cm} | X | p{4cm} |} \hline
\rowcolor{gray!33} No. & Date & Version & Subject of Amendments & Author \\ \hline

1 & YYYY-MM-DD & \arrowversion & & Xxx Yyy \\ \hline
\end{tabularx}

\subsection{Quality Assurance}

\noindent\begin{tabularx}{\textwidth}{| p{1cm} | p{3cm} | p{2cm} | X |} \hline
\rowcolor{gray!33} No. & Date & Version & Approved by \\ \hline

1 & YYYY-MM-DD & \arrowversion  &  \\ \hline

\end{tabularx}

\end{document}